# IsaacLab实验室
# IsaacLab Logistics VLA 使用指南

## 一、安装扩展包

### 步骤 1：安装

```bash
cd /home/junzhe/IsaacLab-2.2.1

# 使用 IsaacLab 的 Python 环境安装（推荐）
./isaaclab.sh -p -m pip install -e source/isaaclab_logistics_vla
```

### 步骤 2：验证安装

```bash
# 运行测试脚本
./isaaclab.sh -p source/isaaclab_logistics_vla/test_installation.py

# 或者在 Python 中测试
./isaaclab.sh -p
>>> import isaaclab_logistics_vla
>>> print(isaaclab_logistics_vla.__version__)
>>> # 应该输出: 0.1.0
```

---

## 二、基础使用

### 方法 1：直接使用 Gym 环境（推荐）

```python
import gymnasium as gym
import isaaclab_logistics_vla  # 这会自动注册环境

# 创建环境
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", num_envs=1)

# 查看环境信息
print(f"观测空间: {env.observation_space}")
print(f"动作空间: {env.action_space}")

# 重置环境
obs, info = env.reset()

# 执行动作
action = env.action_space.sample()
obs, reward, terminated, truncated, info = env.step(action)

# 关闭环境
env.close()
```

### 方法 2：使用配置类直接创建

```python
from isaaclab_logistics_vla.tasks.single_arm_sorting.config.franka import FrankaSingleArmSortingEnvCfg
from isaaclab.envs import ManagerBasedRLEnv

# 创建配置
env_cfg = FrankaSingleArmSortingEnvCfg()
env_cfg.scene.num_envs = 1  # 设置环境数量

# 创建环境
env = ManagerBasedRLEnv(env_cfg)

# 使用环境
obs, info = env.reset()
action = env.action_space.sample()
obs, reward, terminated, truncated, info = env.step(action)
```

### 方法 3：使用统一入口脚本（推荐用于快速测试）

项目根目录提供了统一的 `random_agent.py` 入口脚本，支持所有已注册的任务。

**基本用法：**

```bash
# 激活conda环境
conda activate env_isaaclab

# 进入项目目录
cd /home/junzhe/IsaacLab-2.2.1/source/isaaclab_logistics_vla

# 运行Realman抓取任务
python random_agent.py --task Isaac-Realman-lift --num_envs 2

# 运行Franka分拣任务
python random_agent.py --task Isaac-Logistics-SingleArmSorting-Franka-v0 --num_envs 4

# 使用GPU（默认）
python random_agent.py --task Isaac-Realman-lift --num_envs 2 --device cuda:0

# 使用CPU
python random_agent.py --task Isaac-Realman-lift --num_envs 2 --device cpu

# 禁用fabric（使用USD I/O）
python random_agent.py --task Isaac-Realman-lift --num_envs 2 --disable_fabric
```

**可用任务列表：**

- `Isaac-Realman-lift`: Realman机器人抓取任务
- `Isaac-Logistics-SingleArmSorting-Franka-v0`: Franka机器人单臂分拣任务

**注意事项：**

1. 确保已正确安装扩展包：`./isaaclab.sh -p -m pip install -e source/isaaclab_logistics_vla`
2. 确保在正确的conda环境中运行：`conda activate env_isaaclab`
3. 如果任务未找到，脚本会自动列出所有可用的Isaac任务

---

## 三、创建测试脚本

### 脚本 1：基础环境测试

创建文件：`scripts/test_logistics_env.py`

```python
"""
测试物流 VLA 环境的基础功能
"""

import argparse

from isaaclab.app import AppLauncher

# 解析参数
parser = argparse.ArgumentParser(description="测试物流 VLA 环境")
parser.add_argument("--num_envs", type=int, default=1, help="环境数量")
AppLauncher.add_app_launcher_args(parser)
args_cli = parser.parse_args()

# 启动 Isaac Sim
app_launcher = AppLauncher(args_cli)
simulation_app = app_launcher.app

# 导入环境
import gymnasium as gym
import isaaclab_logistics_vla

def main():
    # 创建环境
    env = gym.make(
        "Isaac-Logistics-SingleArmSorting-Franka-v0",
        num_envs=args_cli.num_envs,
        device=args_cli.device,
    )
    
    print("=" * 60)
    print("环境信息")
    print("=" * 60)
    print(f"环境名称: Isaac-Logistics-SingleArmSorting-Franka-v0")
    print(f"环境数量: {args_cli.num_envs}")
    print(f"观测空间: {env.observation_space}")
    print(f"动作空间: {env.action_space}")
    print("=" * 60)
    
    # 重置环境
    obs, info = env.reset()
    print(f"\n环境重置成功！")
    print(f"观测形状: {obs['policy'].shape if isinstance(obs, dict) else obs.shape}")
    
    # 运行几步
    print(f"\n运行 10 步测试...")
    for i in range(10):
        action = env.action_space.sample()
        obs, reward, terminated, truncated, info = env.step(action)
        print(f"步骤 {i+1}: 奖励 = {reward[0]:.4f}")
        
        if terminated.any() or truncated.any():
            obs, info = env.reset()
            print(f"  环境重置")
    
    print("\n测试完成！")
    env.close()
    simulation_app.close()

if __name__ == "__main__":
    main()
```

**运行方式：**

```bash
cd /home/junzhe/IsaacLab-2.2.1

# GUI 模式（可以看到场景）
./isaaclab.sh -p scripts/test_logistics_env.py --num_envs 1

# 无头模式（服务器）
./isaaclab.sh -p scripts/test_logistics_env.py --num_envs 1 --headless
```

### 脚本 2：可视化测试（带相机）

创建文件：`scripts/test_logistics_env_with_camera.py`

```python
"""
测试物流 VLA 环境，包含相机可视化
"""

import argparse
from pathlib import Path

import imageio
import numpy as np
import torch

from isaaclab.app import AppLauncher

parser = argparse.ArgumentParser(description="测试物流 VLA 环境（带相机）")
parser.add_argument("--num_envs", type=int, default=1)
parser.add_argument("--video-path", type=str, default="./videos/logistics_test.mp4")
parser.add_argument("--max-steps", type=int, default=300)
AppLauncher.add_app_launcher_args(parser)
args_cli = parser.parse_args()

app_launcher = AppLauncher(args_cli)
simulation_app = app_launcher.app

import gymnasium as gym
import isaaclab_logistics_vla

def main():
    # 创建环境
    env = gym.make(
        "Isaac-Logistics-SingleArmSorting-Franka-v0",
        num_envs=args_cli.num_envs,
        device=args_cli.device,
    )
    
    # 创建视频 writer（如果需要）
    if args_cli.video_path:
        video_path = Path(args_cli.video_path)
        video_path.parent.mkdir(parents=True, exist_ok=True)
        writer = imageio.get_writer(str(video_path), fps=30, codec="libx264", quality=8)
        print(f"[INFO] 录制视频到: {video_path}")
    
    # 重置环境
    obs, info = env.reset()
    
    step_count = 0
    while simulation_app.is_running() and step_count < args_cli.max_steps:
        with torch.inference_mode():
            # 随机动作
            action = env.action_space.sample()
            
            # 执行动作
            obs, reward, terminated, truncated, info = env.step(action)
            
            step_count += 1
            
            # 定期重置
            if terminated.any() or truncated.any():
                obs, info = env.reset()
                print(f"[INFO] 步骤 {step_count}: 环境重置")
            
            # 打印信息（每 50 步）
            if step_count % 50 == 0:
                print(f"[INFO] 步骤 {step_count}/{args_cli.max_steps}, 奖励: {reward[0]:.4f}")
    
    if args_cli.video_path:
        writer.close()
        print(f"[INFO] 视频已保存: {video_path}")
    
    env.close()
    simulation_app.close()

if __name__ == "__main__":
    main()
```

---

## 四、使用场景

### 场景 1：快速测试环境

```python
import gymnasium as gym
import isaaclab_logistics_vla

# 创建环境
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", num_envs=1)

# 重置并查看观测
obs, info = env.reset()
print("观测键:", list(obs.keys()) if isinstance(obs, dict) else "非字典")
print("观测形状:", obs['policy'].shape if isinstance(obs, dict) else obs.shape)

# 执行随机动作
for _ in range(100):
    action = env.action_space.sample()
    obs, reward, terminated, truncated, info = env.step(action)
    if terminated.any() or truncated.any():
        obs, info = env.reset()

env.close()
```

### 场景 2：自定义配置

```python
from isaaclab_logistics_vla.tasks.single_arm_sorting.config.franka import FrankaSingleArmSortingEnvCfg
from isaaclab.envs import ManagerBasedRLEnv

# 创建配置
env_cfg = FrankaSingleArmSortingEnvCfg()

# 修改配置
env_cfg.scene.num_envs = 4  # 4 个并行环境
env_cfg.scene.env_spacing = 3.0  # 环境间距
env_cfg.episode_length_s = 10.0  # 更长的 episode

# 修改奖励权重
env_cfg.rewards.grasping_success.weight = 20.0  # 增加抓取奖励

# 创建环境
env = ManagerBasedRLEnv(env_cfg)
```

### 场景 3：与 RL 框架集成

#### 使用 RSL RL

```python
import gymnasium as gym
import isaaclab_logistics_vla
from isaaclab_tasks.utils import parse_env_cfg

# 解析环境配置
env_cfg = parse_env_cfg(
    "Isaac-Logistics-SingleArmSorting-Franka-v0",
    device="cuda:0",
    num_envs=4096,
)

# 创建环境
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", cfg=env_cfg)

# 然后使用 RSL RL 训练
# ... 训练代码 ...
```

#### 使用 SKRL

```python
import gymnasium as gym
import isaaclab_logistics_vla
from skrl.agents.torch.ppo import PPO, PPO_DEFAULT_CONFIG

# 创建环境
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", num_envs=4096)

# 配置 PPO
cfg = PPO_DEFAULT_CONFIG.copy()
cfg["learning_rate"] = 3e-4
cfg["batch_size"] = 4096

# 创建智能体
agent = PPO(
    models={"policy": policy_model, "value": value_model},
    memory={"policy": memory},
    cfg=cfg,
    observation_space=env.observation_space,
    action_space=env.action_space,
    device="cuda:0",
)

# 训练
# ... 训练循环 ...
```

---

## 五、常用操作

### 1. 查看环境信息

```python
import gymnasium as gym
import isaaclab_logistics_vla

env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", num_envs=1)

# 查看观测空间
print("观测空间:", env.observation_space)

# 查看动作空间
print("动作空间:", env.action_space)

# 查看环境属性
print("环境数量:", env.unwrapped.num_envs)
print("设备:", env.unwrapped.device)

env.close()
```

### 2. 访问场景对象

```python
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", num_envs=1)
obs, info = env.reset()

# 访问场景
scene = env.unwrapped.scene

# 访问机器人
robot = scene["robot"]
print("机器人关节位置:", robot.data.joint_pos)

# 访问物体
object = scene["object"]
print("物体位置:", object.data.root_pos_w)

# 访问目标区域
target_area = scene["target_area"]
print("目标区域位置:", target_area.data.root_pos_w)
```

### 3. 手动控制机器人

```python
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", num_envs=1)
obs, info = env.reset()

# 获取场景
scene = env.unwrapped.scene
sim = env.unwrapped.sim

# 手动设置机器人关节位置
robot = scene["robot"]
joint_pos = robot.data.default_joint_pos.clone()
joint_pos[0, 0] = 0.5  # 设置第一个关节角度
robot.set_joint_position_target(joint_pos)

# 写入仿真
scene.write_data_to_sim()
sim.step()
scene.update(sim.get_physics_dt())
```

### 4. 修改物体位置

```python
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", num_envs=1)
obs, info = env.reset()

# 获取物体
object = env.unwrapped.scene["object"]

# 设置新位置
new_pos = torch.tensor([[0.5, 0.0, 0.1]], device=object.device)
object.write_root_pose_to_sim(
    torch.cat([new_pos, torch.tensor([[1.0, 0.0, 0.0, 0.0]], device=object.device)], dim=1)
)
```

---

## 六、调试技巧

### 1. 打印观测信息

```python
obs, info = env.reset()

if isinstance(obs, dict):
    print("观测字典键:", list(obs.keys()))
    for key, value in obs.items():
        print(f"  {key}: shape={value.shape}, dtype={value.dtype}")
else:
    print(f"观测: shape={obs.shape}, dtype={obs.dtype}")
```

### 2. 可视化场景

```python
# 在 GUI 模式下运行，可以查看场景
# 设置相机视角
sim = env.unwrapped.sim
sim.set_camera_view(eye=[2.0, 2.0, 2.0], target=[0.0, 0.0, 0.0])
```

### 3. 检查奖励

```python
obs, info = env.reset()
action = env.action_space.sample()
obs, reward, terminated, truncated, info = env.step(action)

print(f"奖励: {reward}")
print(f"信息: {info}")
```

---

## 七、常见问题

### Q1: 环境创建失败

**错误：** `gym.error.UnregisteredEnv`

**解决：**
```python
# 确保导入了扩展包
import isaaclab_logistics_vla  # 这会注册环境

# 然后创建环境
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0")
```

### Q2: 找不到配置类

**错误：** `ImportError: cannot import name 'FrankaSingleArmSortingEnvCfg'`

**解决：**
```python
# 确保已安装扩展包
# 重新安装
./isaaclab.sh -p -m pip install -e source/isaaclab_logistics_vla --force-reinstall
```

### Q3: CUDA 内存不足

**错误：** `RuntimeError: CUDA out of memory`

**解决：**
```python
# 减少环境数量
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", num_envs=512)  # 减少到 512

# 或使用 CPU（不推荐，会很慢）
env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0", num_envs=1, device="cpu")
```

---

## 八、下一步开发

### 1. 完善当前任务

- [ ] 添加事件配置（重置物体位置）
- [ ] 改进奖励函数
- [ ] 添加更多随机化

### 2. 添加视觉传感器

- [ ] 配置相机
- [ ] 添加视觉观测
- [ ] 测试图像质量

### 3. 添加语言指令

- [ ] 实现语言解析器
- [ ] 添加指令编码
- [ ] 集成到观测空间

### 4. 扩展到其他任务

- [ ] 双臂协同任务
- [ ] 推拉任务
- [ ] 移动机器人任务

---

## 九、完整示例脚本

创建一个完整的测试脚本：`scripts/environments/test_logistics_single_arm.py`

```python
"""
完整的物流单臂分拣环境测试脚本
"""

import argparse
from pathlib import Path

import torch

from isaaclab.app import AppLauncher

parser = argparse.ArgumentParser(description="测试物流单臂分拣环境")
parser.add_argument("--num_envs", type=int, default=1, help="环境数量")
parser.add_argument("--headless", action="store_true", help="无头模式")
AppLauncher.add_app_launcher_args(parser)
args_cli = parser.parse_args()

app_launcher = AppLauncher(args_cli)
simulation_app = app_launcher.app

import gymnasium as gym
import isaaclab_logistics_vla

def main():
    print("=" * 60)
    print("物流 VLA - 单臂分拣环境测试")
    print("=" * 60)
    
    # 创建环境
    env = gym.make(
        "Isaac-Logistics-SingleArmSorting-Franka-v0",
        num_envs=args_cli.num_envs,
        device=args_cli.device,
    )
    
    # 打印环境信息
    print(f"\n环境信息:")
    print(f"  环境名称: Isaac-Logistics-SingleArmSorting-Franka-v0")
    print(f"  环境数量: {args_cli.num_envs}")
    print(f"  设备: {args_cli.device}")
    print(f"  观测空间: {env.observation_space}")
    print(f"  动作空间: {env.action_space}")
    
    # 重置环境
    print(f"\n重置环境...")
    obs, info = env.reset()
    
    if isinstance(obs, dict):
        print(f"观测字典键: {list(obs.keys())}")
        for key, value in obs.items():
            print(f"  {key}: shape={value.shape}, dtype={value.dtype}")
    else:
        print(f"观测: shape={obs.shape}, dtype={obs.dtype}")
    
    # 运行仿真
    print(f"\n运行仿真（100 步）...")
    total_reward = 0.0
    
    for step in range(100):
        with torch.inference_mode():
            # 随机动作
            action = env.action_space.sample()
            
            # 执行动作
            obs, reward, terminated, truncated, info = env.step(action)
            
            total_reward += reward[0].item()
            
            # 重置环境
            if terminated.any() or truncated.any():
                obs, info = env.reset()
                print(f"  步骤 {step}: 环境重置")
    
    print(f"\n总奖励: {total_reward:.4f}")
    print(f"平均奖励: {total_reward/100:.4f}")
    print("\n测试完成！")
    
    env.close()
    simulation_app.close()

if __name__ == "__main__":
    main()
```

**运行：**

```bash
cd /home/junzhe/IsaacLab-2.2.1

# GUI 模式
./isaaclab.sh -p scripts/environments/test_logistics_single_arm.py --num_envs 1

# 无头模式
./isaaclab.sh -p scripts/environments/test_logistics_single_arm.py --num_envs 1 --headless
```

---

## 总结

安装后的使用流程：

1. **安装扩展包**：`./isaaclab.sh -p -m pip install -e source/isaaclab_logistics_vla`
2. **导入包**：`import isaaclab_logistics_vla`
3. **创建环境**：`env = gym.make("Isaac-Logistics-SingleArmSorting-Franka-v0")`
4. **使用环境**：标准的 Gymnasium API（reset, step, close）

需要我帮你创建这些测试脚本吗？

